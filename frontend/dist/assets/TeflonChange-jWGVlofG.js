import{j as e}from"./query-B88w_-l3.js";import{r as n}from"./vendor-BKU87Gzz.js";import{u as U,j as G,r as F,m,e as E,W as L,v as V,k as W,c as J}from"./index-DY2ZM4tI.js";import{a as Z}from"./router-Cr3qqr-L.js";import{F as _}from"./ArrowLeftIcon-DeKPabn9.js";import{F as P}from"./CalendarIcon-C8U54hvR.js";import{F as y}from"./CameraIcon-C8z062Q3.js";import"./utils-CZH8StwO.js";const se=()=>{const{user:c}=U(),x=Z(),[S,u]=n.useState([]),[h,g]=n.useState(!1),[j,o]=n.useState(null),[C,R]=n.useState(!1),[b,v]=n.useState([]),[s,k]=n.useState({machineId:"",teflonType:"",expiryDate:"",observations:""}),[N,A]=n.useState([]),{filterMachinesByPermissions:D,loading:p}=G(),q=[{value:"PTFE",label:"PTFE - Politetrafluoretileno"},{value:"FEP",label:"FEP - Fluorinated Ethylene Propylene"},{value:"PFA",label:"PFA - Perfluoroalkoxy"},{value:"ETFE",label:"ETFE - Ethylene Tetrafluoroethylene"}];n.useEffect(()=>{p||O()},[p]),n.useEffect(()=>{if(s.teflonType){const a=new Date,r=new Date(a.getTime()+5*24*60*60*1e3);k(t=>({...t,expiryDate:r.toISOString().split("T")[0]}))}},[s.teflonType]);const O=async()=>{try{console.log("🔄 TeflonChange: Carregando máquinas...",{permissionsLoading:p,user:c==null?void 0:c.role});const a=await F.get("/machines");if(console.log("📡 TeflonChange: Resposta da API:",a.data),a.data&&Array.isArray(a.data.data)){const r=a.data.data;console.log("📋 TeflonChange: Máquinas recebidas:",r.length),console.log("🔍 TeflonChange: Aplicando filtro canOperate...");const t=D(r,"canOperate");console.log("✅ TeflonChange: Máquinas após filtro canOperate:",t.length),t.length===0&&(c==null?void 0:c.role)==="OPERATOR"&&(console.log("⚠️ TeflonChange: ATENÇÃO - Nenhuma máquina disponível para operador!"),console.log("   Verifique se o operador tem permissão canOperate=true em alguma máquina.")),u(t)}else console.log("❌ TeflonChange: Resposta inválida da API"),u([])}catch(a){console.error("❌ TeflonChange: Erro ao carregar máquinas:",a),o("Erro ao carregar lista de máquinas"),u([])}},f=a=>{const{name:r,value:t}=a.target;k(l=>({...l,[r]:t}))},I=async a=>{const r=Array.from(a.target.files);if(r.length===0)return;const t=["image/jpeg","image/jpg","image/png","image/webp"];if(r.filter(i=>!t.includes(i.type)).length>0){o("Apenas arquivos de imagem (JPEG, PNG, WebP) são permitidos");return}const $=5*1024*1024;if(r.filter(i=>i.size>$).length>0){o("Cada foto deve ter no máximo 5MB");return}g(!0);try{const i=new FormData;r.forEach(d=>{i.append("images",d)});const w=await fetch("/api/upload/teflon-images",{method:"POST",headers:{Authorization:`Bearer ${localStorage.getItem("token")}`},body:i}),T=await w.json();if(!w.ok)throw new Error(T.message||"Erro ao fazer upload das fotos");const B=T.data.map(d=>d.filename);A(d=>[...d,...B]),v(d=>[...d,...r]),o(null)}catch(i){o(i.message||"Erro ao fazer upload das fotos")}finally{g(!1)}},M=a=>{v(r=>r.filter((t,l)=>l!==a))},z=async a=>{var r,t;if(a.preventDefault(),!s.machineId){o("Selecione uma máquina");return}if(!s.teflonType){o("Selecione o tipo de teflon");return}if(N.length===0){o("É obrigatório anexar pelo menos uma foto");return}g(!0),o(null);try{const l={machineId:s.machineId,teflonType:s.teflonType,expiryDate:s.expiryDate,observations:s.observations||"",photos:N};await F.post("/teflon",l),R(!0),setTimeout(()=>{x("/teflon")},2e3)}catch(l){console.error("Erro ao registrar troca:",l),o(((t=(r=l.response)==null?void 0:r.data)==null?void 0:t.message)||"Erro ao registrar troca de teflon")}finally{g(!1)}};return C?e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsxs(m.div,{initial:{scale:0},animate:{scale:1},className:"text-center p-8 bg-white rounded-lg shadow-lg",children:[e.jsx(E,{className:"h-16 w-16 text-green-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Troca Registrada!"}),e.jsx("p",{className:"text-gray-600",children:"A troca de teflon foi registrada com sucesso."}),e.jsx("p",{className:"text-sm text-gray-500 mt-2",children:"Redirecionando..."})]})}):e.jsxs(e.Fragment,{children:[e.jsx(L,{children:e.jsx("title",{children:"Nova Troca de Teflon - Zara Operação"})}),e.jsx("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900 py-6",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:[e.jsxs(m.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"mb-8",children:[e.jsxs("button",{onClick:()=>x("/teflon"),className:"flex items-center text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white mb-6 transition-colors",children:[e.jsx(_,{className:"h-5 w-5 mr-2"}),"Voltar para Teflon"]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white mb-2",children:"Nova Troca de Teflon"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Registre uma nova troca de teflon com fotos obrigatórias"})]})]}),e.jsx(m.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.1},className:"bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6",children:e.jsxs("form",{onSubmit:z,className:"space-y-8",children:[e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 rounded-lg p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center",children:[e.jsx(V,{className:"h-5 w-5 mr-2 text-blue-600 dark:text-blue-400"}),"Informações Básicas"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Máquina *"}),e.jsxs("select",{name:"machineId",value:s.machineId,onChange:f,className:"w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent transition-colors",required:!0,children:[e.jsx("option",{value:"",children:"Selecione uma máquina"}),S.map(a=>e.jsxs("option",{value:a.id,children:[a.name," - ",a.location]},a.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Tipo de Teflon *"}),e.jsxs("select",{name:"teflonType",value:s.teflonType,onChange:f,className:"w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent transition-colors",required:!0,children:[e.jsx("option",{value:"",children:"Selecione o tipo de teflon"}),q.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))]})]})]})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 rounded-lg p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center",children:[e.jsx(P,{className:"h-5 w-5 mr-2 text-blue-600 dark:text-blue-400"}),"Detalhes da Troca"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Data de Validade (Automática - 5 dias)"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"date",name:"expiryDate",value:s.expiryDate,readOnly:!0,className:"w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-600 dark:text-gray-400"}),e.jsx(P,{className:"absolute right-3 top-3.5 h-5 w-5 text-gray-400"})]}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-2",children:"A data de validade é calculada automaticamente para 5 dias após a troca"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Observações"}),e.jsx("textarea",{name:"observations",value:s.observations,onChange:f,rows:4,className:"w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 focus:border-transparent transition-colors resize-none",placeholder:"Adicione observações sobre a troca (opcional)"})]})]})]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 rounded-lg p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center",children:[e.jsx(y,{className:"h-5 w-5 mr-2 text-blue-600 dark:text-blue-400"}),"Fotos * (Obrigatório)"]}),e.jsxs("div",{className:"border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 text-center hover:border-blue-400 dark:hover:border-blue-500 transition-colors",children:[e.jsx(y,{className:"h-16 w-16 text-gray-400 dark:text-gray-500 mx-auto mb-4"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("label",{className:"cursor-pointer",children:[e.jsxs("span",{className:"inline-flex items-center px-6 py-3 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white rounded-lg font-medium transition-colors",children:[e.jsx(y,{className:"h-5 w-5 mr-2"}),"Selecionar Fotos"]}),e.jsx("input",{type:"file",multiple:!0,accept:"image/*",onChange:I,className:"hidden"})]}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Selecione uma ou mais fotos (JPEG, PNG, WebP - máx. 5MB cada)"})]})]}),b.length>0&&e.jsxs("div",{className:"mt-6",children:[e.jsxs("p",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 mb-3",children:["Fotos selecionadas (",b.length,"):"]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:b.map((a,r)=>e.jsxs(m.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},className:"relative group",children:[e.jsx("img",{src:URL.createObjectURL(a),alt:`Foto ${r+1}`,className:"w-full h-28 object-cover rounded-lg border border-gray-200 dark:border-gray-600"}),e.jsx("button",{type:"button",onClick:()=>M(r),className:"absolute -top-2 -right-2 bg-red-500 hover:bg-red-600 text-white rounded-full w-7 h-7 flex items-center justify-center text-sm font-bold shadow-lg transition-colors opacity-0 group-hover:opacity-100",children:"×"}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-2 truncate",children:a.name})]},r))})]})]}),j&&e.jsxs(m.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:"flex items-center p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg",children:[e.jsx(W,{className:"h-5 w-5 text-red-500 dark:text-red-400 mr-3 flex-shrink-0"}),e.jsx("span",{className:"text-red-700 dark:text-red-300",children:j})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 pt-8",children:[e.jsx("button",{type:"button",onClick:()=>x("/teflon"),className:"flex-1 px-6 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors font-medium",children:"Cancelar"}),e.jsx("button",{type:"submit",disabled:h,className:J("flex-1 px-6 py-3 rounded-lg text-white font-medium transition-colors flex items-center justify-center",h?"bg-gray-400 dark:bg-gray-600 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600"),children:h?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"}),"Registrando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(E,{className:"h-5 w-5 mr-2"}),"Registrar Troca"]})})]})]})})]})})]})};export{se as default};
//# sourceMappingURL=TeflonChange-jWGVlofG.js.map
