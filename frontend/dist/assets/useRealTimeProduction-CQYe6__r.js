import{r as a}from"./vendor-BKU87Gzz.js";import{f as J}from"./index-DY2ZM4tI.js";const W=(t,B=1e3)=>{const{socket:i}=J(),[F,M]=a.useState({currentProduction:0,runningTime:0,efficiency:0,currentSpeed:0,isRunning:!1}),w=a.useRef(null),c=a.useRef(null),d=a.useRef(null),s=a.useRef(0),g=a.useRef(0),C=a.useRef(null),f=a.useRef(0),l=a.useRef(null),T=r=>`realtime_production_${r}`,v=(r,e)=>{try{const n={...e,lastSaved:new Date().toISOString(),shiftStart:O().toISOString(),lastCalculatedProduction:f.current,lastUpdateTime:l.current?l.current.toISOString():null};localStorage.setItem(T(r),JSON.stringify(n))}catch(n){console.warn("Erro ao salvar dados de produção:",n)}},N=r=>{try{const e=localStorage.getItem(T(r));if(!e)return null;const n=JSON.parse(e),u=O(),o=new Date(n.shiftStart);return u.getTime()===o.getTime()?{accumulatedProduction:n.accumulatedProduction||0,accumulatedRunningTime:n.accumulatedRunningTime||0,startTime:n.startTime?new Date(n.startTime):null,lastStatus:n.lastStatus,lastCalculatedProduction:n.lastCalculatedProduction||0,lastUpdateTime:n.lastUpdateTime?new Date(n.lastUpdateTime):null}:(localStorage.removeItem(T(r)),null)}catch(e){return console.warn("Erro ao carregar dados de produção:",e),null}},m=(r,e)=>Math.max(0,Math.floor(r*e)),_=(r,e)=>{if(!l.current)return l.current=r,0;const n=(r-l.current)/1e3;if(n<1)return 0;const u=e/60,o=n*u;return l.current=r,Math.max(0,o)},U=r=>{const e=Math.floor(r/60),n=Math.floor(r%60);return`${e}h ${n}m`},R=r=>r==="FUNCIONANDO"||r==="RUNNING",k=r=>r==="FORA_DE_TURNO"||r==="OFF_SHIFT",I=a.useCallback(()=>{var E;if(!t||!t.productionSpeed)return;const r=t.productionSpeed,e=new Date,n=R(t.status),u=k(t.status);if(d.current!==t.status){if(d.current&&c.current){const P=R(d.current),j=k(d.current);if(P&&!j){const $=(e-c.current)/6e4,q=m($,r);s.current+=q,s.current=Math.max(s.current,f.current||0),f.current=s.current,g.current+=$}}c.current=e,d.current=t.status}c.current||(c.current=e,d.current=t.status);const o=(e-c.current)/(1e3*60);let S=s.current,D=g.current;if(n&&!u){const P=_(e,r);P>0&&(s.current+=P,s.current=Math.max(s.current,f.current||0),f.current=s.current),S=s.current,D+=o}else l.current=null,S=s.current;const b=O(),x=(e-b)/(1e3*60),z=x>0?Math.round(D/x*100):0,H=r*480,A={currentProduction:Math.max(0,S),runningTime:D,runningTimeFormatted:U(D),efficiency:Math.min(100,Math.max(0,z)),currentSpeed:n?r:0,isRunning:n,targetProduction:H,lastUpdate:e};M(A),t!=null&&t.id&&v(t.id,{accumulatedProduction:s.current,accumulatedRunningTime:g.current,startTime:(E=c.current)==null?void 0:E.toISOString(),lastStatus:d.current})},[t]),p=a.useCallback(async()=>{var r;if(t!=null&&t.id){try{const e=localStorage.getItem("token"),n=await fetch(`/api/machines/${t.id}/production/current-shift`,{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(n.ok){const u=await n.json();if(u.success&&u.data){const o=u.data,S={currentProduction:Math.max(0,o.estimatedProduction||0),runningTime:o.runningMinutes||0,runningTimeFormatted:U(o.runningMinutes||0),efficiency:Math.min(100,Math.max(0,o.efficiency||0)),currentSpeed:R(t.status)?t.productionSpeed:0,isRunning:R(t.status),targetProduction:t.productionSpeed*480,lastUpdate:new Date};s.current=o.estimatedProduction||0,g.current=o.runningMinutes||0,f.current=o.estimatedProduction||0,M(S),t!=null&&t.id&&v(t.id,{accumulatedProduction:s.current,accumulatedRunningTime:g.current,startTime:(r=c.current)==null?void 0:r.toISOString(),lastStatus:d.current});return}}}catch(e){console.error("Erro ao buscar dados de produção:",e)}I()}},[t==null?void 0:t.id,t==null?void 0:t.status,t==null?void 0:t.productionSpeed,I]),O=()=>{const r=new Date,e=new Date(r.getFullYear(),r.getMonth(),r.getDate()),n=r.getHours();if(n>=7&&n<19)return new Date(e.getTime()+7*60*60*1e3);if(n>=19)return new Date(e.getTime()+19*60*60*1e3);{const u=new Date(e.getTime()-864e5);return new Date(u.getTime()+19*60*60*1e3)}},y=()=>{const r=new Date,e=r.getHours();console.log(`🔄 Resetando produção às ${e}:${r.getMinutes().toString().padStart(2,"0")}`),s.current=0,g.current=0,c.current=new Date,d.current=t==null?void 0:t.status,f.current=0,l.current=null,t!=null&&t.id&&(localStorage.removeItem(T(t.id)),console.log(`🗑️ Dados do localStorage limpos para máquina ${t.id}`)),M({currentProduction:0,runningTime:0,efficiency:0,currentSpeed:0,isRunning:!1})};return a.useEffect(()=>{if(t!=null&&t.id&&t.id!==C.current){C.current=t.id;const r=N(t.id);r?(s.current=r.accumulatedProduction,g.current=r.accumulatedRunningTime,c.current=r.startTime,d.current=r.lastStatus,f.current=r.lastCalculatedProduction||0,l.current=r.lastUpdateTime):(s.current=0,g.current=0,c.current=null,d.current=null,f.current=0,l.current=null)}},[t==null?void 0:t.id]),a.useEffect(()=>{if(t!=null&&t.id&&t&&t.hasOwnProperty("productionSpeed"))return p(),w.current=setInterval(()=>{p()},3e4),()=>{w.current&&clearInterval(w.current)}},[t,p]),a.useEffect(()=>{const e=setInterval(()=>{const n=new Date,u=n.getHours(),o=n.getMinutes();(u===7||u===19)&&o>=0&&o<=1&&(console.log(`🔄 Mudança de turno detectada às ${u}:${o.toString().padStart(2,"0")} - Resetando produção`),y())},3e4);return()=>clearInterval(e)},[]),a.useEffect(()=>{if(!i||!(t!=null&&t.id))return;const r=o=>{o.machineId===t.id&&(console.log("🔄 Status da máquina alterado via WebSocket:",o),p())},e=o=>{o.machineId===t.id&&p()},n=o=>{o.machineId===t.id&&(console.log("🚀 Operação iniciada - atualizando produção:",o),y(),p())},u=o=>{o.machineId===t.id&&(console.log("🛑 Operação finalizada - atualizando produção:",o),p())};return i.on("machine:status:changed",r),i.on("machine:operation-started",n),i.on("machine:operation-ended",u),i.on("production:update",e),()=>{i.off("machine:status:changed",r),i.off("machine:operation-started",n),i.off("machine:operation-ended",u),i.off("production:update",e)}},[i,t==null?void 0:t.id,p,I]),{...F,resetProduction:y}};export{W as u};
//# sourceMappingURL=useRealTimeProduction-CQYe6__r.js.map
